@page "/"
@page "/bedrock"
@using Amazon.BedrockAgent
@using Amazon.BedrockAgent.Model
@using Amazon.BedrockAgentRuntime
@using Amazon.BedrockAgentRuntime.Model
@using Amazon.BedrockRuntime
@using Amazon.GenAI.Abstractions.Bedrock
@using Amazon.GenAI.Abstractions.ChatHistory
@using Amazon.GenAI.Abstractions.Message
@using Amazon.GenAI.Components
@using Amazon.GenAI.Models
@using Markdig
@inject MarkdownPipeline Pipeline
@inject IJSRuntime JsRuntime
@inject AmazonBedrockRuntimeClient BedrockRuntimeClient


<MudStack Style="width: 100%">
	<MudCard>
		<MudCardContent>
			<div>
				<MudText Typo="Typo.h4">AWS Summit Bedrock</MudText>
			</div>
			<br />
			<MudTimeline Reverse="true">
				@foreach (var item in _chatMessageHistory.Messages)
				{
					var label = item.Role == MessageRole.Human ? "Human" : "Assistant";
					<MudTimelineItem>
						<MudField Label="@label" Class="white-space-pre-line">
							@((MarkupString)Markdown.ToHtml(item.Content, Pipeline))
						</MudField>
					</MudTimelineItem>
				}
				<MudTimelineItem>
					<MudTextField id="PromptId" @ref="_promptField" T="string" ValueChanged="@OnPromptChanged" Label="Human"></MudTextField>
				</MudTimelineItem>
			</MudTimeline>
		</MudCardContent>
		<Progress Status="_status" OnClickCallback="Submit"></Progress>
	</MudCard>
</MudStack>

@code {

	private readonly string? _textModelId = "anthropic.claude-3-haiku-20240307-v1:0";
	private readonly ChatMessageHistory _chatMessageHistory = new();
	private MudTextField<string>? _promptField;
	Status _status = Status.Default;

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();
		StateHasChanged();
	}

	protected Task Submit()
	{
		return Task.CompletedTask;
	}

	private async Task OnPromptChanged(string inputValue)
	{
		if (string.IsNullOrEmpty(inputValue))
			return;

		_status = Status.Thinking;
		StateHasChanged();
		await _chatMessageHistory.AddUserMessage(inputValue);

		var bodyJson = AnthropicClaude3.CreateBodyJson(_chatMessageHistory.Messages.AsHistory());
		var response = await BedrockRuntimeClient.InvokeModelAsync(_textModelId!, bodyJson).ConfigureAwait(false);
		var generatedText = response?["content"]?[0]?["text"]?.GetValue<string>() ?? string.Empty;

		await _chatMessageHistory.AddAiMessage(generatedText!);

		await InvokeAsync(() =>
		{
			_promptField?.SetText("");
			_status = Status.Default;
			JsRuntime.InvokeVoidAsync("scrollToElement", "PromptId");
			StateHasChanged();
			return Task.CompletedTask;
		});
	}
}