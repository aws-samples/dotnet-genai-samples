@page "/"
@using Amazon.BedrockAgent
@using Amazon.BedrockAgent.Model
@using Amazon.BedrockAgentRuntime
@using Amazon.BedrockRuntime
@using Amazon.GenAI.Abstractions.Bedrock
@using Amazon.GenAI.Abstractions.ChatHistory
@using Amazon.GenAI.Abstractions.Message
@using Markdig
@inject MarkdownPipeline Pipeline
@inject IJSRuntime JsRuntime
@inject AmazonBedrockRuntimeClient BedrockRuntimeClient


<MudStack Style="width: 100%">
	<MudCard>
		<MudCardContent>
			<div>
				<MudText Typo="Typo.h4">AWS Summit Bedrock</MudText>
				<MudSelect T="KnowledgeBaseSummary" @bind-Value="_knowledgeBase" ToStringFunc="@_selectConverter" Required="true"
						   Label="Select Knowledgebase"
						   Variant="Variant.Outlined">
					@foreach (var item in _knowledgeBases!)
					{
						_knowledgeBase ??= item;
						<MudSelectItem Value="@item" />
					}
				</MudSelect>
				<div>
					Text Model: <strong>Claude 3 Haiku (@_textModelId)</strong>
				</div>
				<div>@_knowledgeBase?.Description</div>
			</div>
			<br />
			<MudTimeline Reverse="true">
				@foreach (var item in _chatMessageHistory.Messages)
				{
					var label = item.Role == MessageRole.Human ? "Human" : "Assistant";
					<MudTimelineItem>
						<MudField Label="@label" Class="white-space-pre-line">
							@((MarkupString)Markdown.ToHtml(item.Content, Pipeline))
						</MudField>
					</MudTimelineItem>
				}
				<MudTimelineItem>
					<MudTextField id="PromptId" @ref="_promptField" T="string" ValueChanged="@OnPromptChanged" Label="Human"></MudTextField>
				</MudTimelineItem>
			</MudTimeline>
		</MudCardContent>
		<Progress Status="_status" OnClickCallback="Submit"></Progress>
	</MudCard>
</MudStack>

@code {

	#region Variables

	AmazonBedrockAgentRuntimeClient? _agentClient;

	private string? _textModelId;

	enum Status
	{
		Default,
		Thinking,
		Indexing,
		Adding
	}
	Status _status = Status.Default;

	private readonly ChatMessageHistory _chatMessageHistory = new();
	private MudTextField<string>? _promptField;

	private KnowledgeBaseSummary? _knowledgeBase;
	private List<KnowledgeBaseSummary?>? _knowledgeBases = new();
	readonly Func<KnowledgeBaseSummary, string> _selectConverter = kb => string.Concat(kb?.Name, " , (", kb?.KnowledgeBaseId, ")");

	#endregion

	protected override async Task OnInitializedAsync()
	{
	//	_textModelId = "anthropic.claude-3-haiku-20240307-v1:0";
		_textModelId = "amazon.titan-text-lite-v1";

		_agentClient = new AmazonBedrockAgentRuntimeClient();

		var knowledgeBasesRequest = new ListKnowledgeBasesRequest();
		_knowledgeBases = (await new AmazonBedrockAgentClient().ListKnowledgeBasesAsync(knowledgeBasesRequest)).KnowledgeBaseSummaries
			.OrderBy(x => x.UpdatedAt)
			.Where(x => x.Status.Equals("Active"))
			.ToList();

		await base.OnInitializedAsync();
		StateHasChanged();
	}

	private async Task OnPromptChanged(string inputValue)
	{
		if (string.IsNullOrEmpty(inputValue))
			return;

		_status = Status.Thinking;
		StateHasChanged();
		await Task.Delay(1);

		await _chatMessageHistory.AddUserMessage(inputValue);

		var bodyJson = AmazonTitanText.CreateBodyJson(_chatMessageHistory.Messages.AsHistory());
		var response = await BedrockRuntimeClient.InvokeModelAsync(_textModelId!, bodyJson).ConfigureAwait(false);
		var generatedText = response?["results"]?[0]?["outputText"]?.GetValue<string>() ?? string.Empty;

		await _chatMessageHistory.AddAiMessage(generatedText!);

		await InvokeAsync(() =>
		{
			_promptField?.SetText("");
			_status = Status.Default;
			StateHasChanged();
			return Task.CompletedTask;
		});
	}

	// private async Task OnPromptChanged(string question)
	// {
	//     if (string.IsNullOrEmpty(question))
	//         return;

	//     _status = Status.Thinking;
	//     StateHasChanged();

	//     await _chatMessageHistory.AddUserMessage(question);

	//     var request = new RetrieveAndGenerateRequest
	//         {
	//             Input = new RetrieveAndGenerateInput { Text = question },
	//             RetrieveAndGenerateConfiguration = new RetrieveAndGenerateConfiguration
	//             {
	//                 Type = RetrieveAndGenerateType.KNOWLEDGE_BASE,
	//                 KnowledgeBaseConfiguration = new KnowledgeBaseRetrieveAndGenerateConfiguration
	//                 {
	//                     KnowledgeBaseId = _knowledgeBase?.KnowledgeBaseId,
	//                     ModelArn = _textModelId,
	//                     RetrievalConfiguration = new KnowledgeBaseRetrievalConfiguration
	//                     {
	//                         VectorSearchConfiguration = new KnowledgeBaseVectorSearchConfiguration
	//                         {
	//                             OverrideSearchType = "HYBRID",
	//                             // Filter = new RetrievalFilter
	//                             // {
	//                             //     Equals = new FilterAttribute
	//                             //     {
	//                             //         Key = "year",
	//                             //         Value = new Document(2020)
	//                             //     }
	//                             // }
	//                         }
	//                     }
	//                 }
	//             }
	//         };
	//     var result = await _agentClient!.RetrieveAndGenerateAsync(request);

	//     await _chatMessageHistory.AddAiMessage(result.Output.Text!);

	//     await InvokeAsync(() =>
	//     {
	//         _promptField?.SetText("");
	//         _status = Status.Default;
	//         JsRuntime.InvokeVoidAsync("scrollToElement", "PromptId");

	//         StateHasChanged();
	//         return Task.CompletedTask;
	//     });
	// }

	#region Utility Methods

	private async Task Clear()
	{
		await _chatMessageHistory.Clear();
		await _promptField?.SetText("")!;
		await Task.Delay(100);
	}

	private async Task Reset(MouseEventArgs e)
	{
		await _promptField?.SetText("")!;
		await _chatMessageHistory.Clear();
	}

	#endregion
}